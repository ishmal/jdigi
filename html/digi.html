<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">




<script src="http://code.jquery.com/jquery-1.10.1.min.js"></script>
<script src="../src/resample.js"></script>

<script>

function DigiTest(anchorName) {

    var self = this;
    
    var fftSize = 2048;

    var anchor = $(anchorName);

    //Let's get the local implementations
    window.requestAnimationFrame = window.requestAnimationFrame ||
                                   window.msRequestAnimationFrame ||
                                   window.mozRequestAnimationFrame ||
                                   window.webkitRequestAnimationFrame;

    window.AudioContext = window.AudioContext ||
                          window.webkitAudioContext;

    navigator.getUserMedia = navigator.getUserMedia ||
                             navigator.webkitGetUserMedia ||
                             navigator.mozGetUserMedia ||
                             navigator.msGetUserMedia;


    function trace(msg) {
        if (typeof console !== "undefined") 
            console.log("Digi: " + msg);
    }

    function error(msg) {
        if (typeof console !== "undefined") 
            console.log("Digi error: " + msg);
    }

    var actx = new AudioContext();
    var sampleRate = actx.sampleRate


    /**
     * Provides a Waterfall display on incoming spectrum data
     */
    function Waterfall(parent, width, height, bins) {
    
        
        function createIndices(targetsize, sourcesize) {
            var xs = [];
            for (var i=0 ; i < width ; i++) {
                xs.push(Math.floor(i * sourcesize / targetsize));
            }
            return xs;
        }
        
        var indices = createIndices(width, bins);
        
        var canvas = $("<canvas>").width(width).height(height);
        parent.append(canvas);
        var ctx      = canvas.get(0).getContext('2d'); 
        var nrPixels = width*height;
        var lastRow  = nrPixels - width;
        var imgData  = ctx.getImageData(0, 0, width, height);
        var imglen   = imgData.data.length;
        var buf      = new ArrayBuffer(imglen);
        var buf8     = new Uint8ClampedArray(buf);
        var buf32    = new Uint32Array(buf);

        // Determine whether Uint32 is little- or big-endian.
        function testBigEndian() {
            var tbuf = new ArrayBuffer(4);
            var tbuf8 = new Uint8ClampedArray(tbuf);
            var tbuf32 = new Uint32Array(tbuf);
            tbuf32[0] = 0x0a0b0c0d;
            return (tbuf[4] === 0x0a && tbuf[5] === 0x0b &&
                    tbuf[6] === 0x0c && tbuf[7] === 0x0d);
        }
        
        var bigEndian = testBigEndian();
        
        /**
         * Make a palette. tweak this often
         */                 
        function makePalette() {
            var xs = [];
            for (var i = 0 ; i < 256 ; i++) {
                var r = (i < 170) ? 0 : (i-170) * 3;
                var g = (i <  85) ? 0 : (i < 170) ? (i-85) * 3 : 255;
                var b = (i <  85) ? i * 3 : 255;
                if (bigEndian) {
                    var col = (r << 24) | (g << 16) | (b << 8) | 255;
                    xs.push(col);
                } else {
                    var col = (255 << 24) | (b << 16) | (g << 8) | r;
                    xs.push(col);
                }
            }
            return xs;
        }
        
        var palette = makePalette();
        

        var counter = 0;
        
        
        var _buf = [];
        for (var i = 0 ; i < fftSize ; i++)
            _buf.push(0.0);
        
        function drawSpectrum() {
            var data = _buf;
            //trace("len:" + data.length);
            //ctx.clearRect(0,0,width,height);
            //
            ctx.fillStyle = 'midnightblue';
            //ctx.fillRect(0,0,width,height);
            ctx.beginPath();
            ctx.moveTo(0, height);
            for (var x=0; x<width ; x++) {
                var v = Math.log(1.0 + data[indices[x]]);
                var y = height - 10 - 50*v;
                trace("x:" + x + " y:" + y);
                ctx.lineTo(x, y);
            }   
            ctx.lineTo(width-1,height-1);
            ctx.closePath();
            //var bbox = ctx.getBBox();
            ctx.fillStyle = 'rgba(255, 0, 0, 1.0)';
            ctx.fill();           
        }
        
            
        function drawWaterfall() {
        
            var data = _buf;
            /*
            for (var dest = 0, src = width ; src < nrPixels ; dest++, src++) {
                buf32[dest] = buf32[src];
            }
            */
            buf32.set(buf32.subarray(width, buf32.length)); //<-cool, if this works

            var idx = lastRow;
            for (var x=0; x<width ; x++) {
                var v = Math.log(1.0 + data[indices[x]]);
                var y = 50*v;
                //trace("x:" + x + " y:" + y);
                var pix = palette[v & 255];
                buf32[idx++] = pix;
            }   
            
            imgData.data.set(buf8);
            
            ctx.putImageData(imgData, 0, 0);
        }
        
        function redraw() {
            //trace("draw");
            //drawSpectrum();
            drawWaterfall();
        }
        
        
        this.update = function(data) {
            _buf = new Uint8Array(data);
        }
        
        setInterval(redraw, 100);
    
    }//Waterfall
    
    var waterfall = new Waterfall(anchor, 800, 600, fftSize/2);
    

    function receive(data) {
    
    
    }
    
    
    function transmit(data) {
    
    
    }
    
    function createDecimatorAudioNode(ctx, decimation) {
    
        var bufferSize = 8192;
        
        var decimator = new Resampler(decimation);
        
        var node = ctx.createScriptProcessor(bufferSize, 1, 1);
        node.onAudioProcess = function(e) {
            var input = e.inputBuffer.getChannelData(0);
            var output = e.outputBuffer.getChannelData(0);
            var optr = 0;
            function decout(v) {
                output[optr++] = v;
            }
            for (var i=0 ; i < bufferSize ; i++) {
                decimator.decimate(input[i], decout);
            }
            trace("here");
            //we have optr samples of data. Here is where we hook in out digi stuff
        };
        
        return node;
    
    }


    function AudioInput() {
    
        var analyser = null;
        var source = null;
        var isRunning = false;
        
        function start() {
            source.buffer = audioBuffer;
            source.loop = true;
            source.noteOn(0.0);
            isRunning = true; 
        }
        
        
        function stop() {
            if (source) {
                source.noteOff(0);
                source.disconnect();
            }
            isRunning = false;
        }
        
        function process() {
            var data = new Uint8Array(analyser.frequencyBinCount);
            analyser.getByteFrequencyData(data);
            //trace("process:" + data.length);
            waterfall.update(data);
            //requestAnimationFrame(process);
        }
        
        function startStream(stream) {
        
            stop();
        
            var source = actx.createMediaStreamSource(stream);

        
            var inputNode = createDecimatorAudioNode(actx, 6);
            source.connect(inputNode);

            isRunning = true;

            analyser = actx.createAnalyser();
            analyser.smoothingTimeConstant = 0;
            analyser.fftSize = 2048;

            inputNode.connect(analyser);
        
            var spectrumGetter = actx.createScriptProcessor(4096, 1 ,0);
            scriptProcessor.onaudioprocess = function(event) { 
                var xs = new Uint8Array(2048); 
                analyser.getByteFrequencyData(array);          
                waterfall.update(array);
            };
            analyser.connect(spectrumGetter);

            //requestAnimationFrame(process);
            setInterval(process, 100);
        }

        function startup() {
            navigator.getUserMedia(
                { 
                  video: false,
                  audio : true
                }, 
                startStream,
                function(userMediaError) {
                    error(userMediaError.name + " : " + userMediaError.message);
                }
            );
        }
        
        startup();
           
    }//AudioInput
    
    new AudioInput();

} //DigiTest



$(document).ready(function() {

    new DigiTest("#digi");

});



</script>

</head>

<body>
<h3>FFT Test</h3>


<div id="digi"></div>




































</body>
</html>
